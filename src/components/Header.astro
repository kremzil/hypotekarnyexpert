---
import { SITE } from "../config/site";
import { navItems } from "../config/nav";
const currentPath = Astro.url.pathname;
---

<header class="relative border-b border-ink/10 py-6" data-site-header>
  <div class="page-container flex flex-wrap items-center justify-between gap-4">
    <div>
      <a class="inline-flex items-center no-underline" href="/">
        <img class="h-12 w-auto" src="/logo.svg" alt={SITE.title} />
        <span class="sr-only">{SITE.title}</span>
      </a>
    </div>
    <nav class="hidden items-center gap-4 md:flex">
      {
        navItems.map((item) => (
          <a
            class="border-b-2 border-transparent pb-1 no-underline text- decoration-accent hover:border-accent"
            href={item.href}
            class:list={[
              "text-md font-medium transition-colors",
              {
                "text-accent": currentPath === item.href,
                "text-ink hover:text-accent": currentPath !== item.href,
              },
            ]}
          >
            {item.label}
          </a>
        ))
      }
    </nav>
    <button
      type="button"
      class="relative inline-flex items-center justify-center rounded-md border border-neutral-200 bg-white p-2 text-neutral-700 shadow-sm transition hover:bg-neutral-50 md:hidden"
      aria-label="Toggle menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
      data-menu-button
    >
      <span class="sr-only">Menu</span>
      <span class="relative h-5 w-5">
        <svg
          data-icon-menu
          class="absolute inset-0 h-5 w-5 opacity-100 transition-all duration-300"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg
          data-icon-close
          class="absolute inset-0 h-5 w-5 -rotate-90 opacity-0 transition-all duration-300"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </span>
    </button>
  </div>

  <div
    class="fixed inset-0 z-40 bg-neutral-900/40 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden"
    aria-hidden="true"
    data-menu-overlay
  ></div>

  <div
    id="mobile-menu"
    class="absolute left-0 right-0 top-full z-50 max-h-0 -translate-y-2 overflow-hidden border-t border-neutral-200 bg-white opacity-0 pointer-events-none shadow-lg transition-[max-height,opacity,transform] duration-300 ease-out md:hidden"
    aria-hidden="true"
    data-mobile-menu
  >
    <nav aria-label="Mobile">
      <ul class="flex flex-col gap-3 px-6 py-4">
        {navItems.map((item) => (
          <li>
            <a
              href={item.href}
              class:list={[
                "text-sm font-medium transition-colors",
                {
                  "text-neutral-900": currentPath === item.href,
                  "text-neutral-600 hover:text-neutral-900": currentPath !== item.href
                }
              ]}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
</header>

<script>
  const header = document.querySelector("[data-site-header]");
  const button = header?.querySelector("[data-menu-button]");
  const menu = header?.querySelector("[data-mobile-menu]");
  const overlay = header?.querySelector("[data-menu-overlay]");
  const pageBody = document.body;
  const menuIcon = button?.querySelector("[data-icon-menu]");
  const closeIcon = button?.querySelector("[data-icon-close]");

  const openClasses = ["max-h-96", "opacity-100", "translate-y-0", "pointer-events-auto"];
  const closedClasses = ["max-h-0", "opacity-0", "-translate-y-2", "pointer-events-none"];

  const isOpen = () => button?.getAttribute("aria-expanded") === "true";

  const openMenu = () => {
    if (!button || !menu || !overlay) return;
    menu.classList.remove(...closedClasses);
    menu.classList.add(...openClasses);
    menu.setAttribute("aria-hidden", "false");
    overlay.classList.remove("opacity-0", "pointer-events-none");
    overlay.classList.add("opacity-100");
    button.setAttribute("aria-expanded", "true");
    pageBody?.classList.add("overflow-hidden");
    menuIcon?.classList.remove("opacity-100", "rotate-0");
    menuIcon?.classList.add("opacity-0", "rotate-90");
    closeIcon?.classList.remove("-rotate-90", "opacity-0");
    closeIcon?.classList.add("opacity-100", "rotate-0");
  };

  const closeMenu = () => {
    if (!button || !menu || !overlay) return;
    menu.classList.remove(...openClasses);
    menu.classList.add(...closedClasses);
    menu.setAttribute("aria-hidden", "true");
    overlay.classList.add("opacity-0", "pointer-events-none");
    overlay.classList.remove("opacity-100");
    button.setAttribute("aria-expanded", "false");
    pageBody?.classList.remove("overflow-hidden");
    menuIcon?.classList.remove("opacity-0", "rotate-90");
    menuIcon?.classList.add("opacity-100", "rotate-0");
    closeIcon?.classList.add("-rotate-90", "opacity-0");
    closeIcon?.classList.remove("opacity-100", "rotate-0");
  };

  const toggleMenu = () => {
    if (isOpen()) {
      closeMenu();
      return;
    }
    openMenu();
  };

  button?.addEventListener("click", toggleMenu);
  overlay?.addEventListener("click", closeMenu);
  document.addEventListener("click", (event) => {
    if (!isOpen()) return;
    const target = event.target;
    if (!(target instanceof Node)) return;
    if (menu?.contains(target) || button?.contains(target)) return;
    closeMenu();
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeMenu();
    }
  });
  menu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      closeMenu();
    });
  });
</script>
